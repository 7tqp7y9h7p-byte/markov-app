<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Markovi Ennustaja</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont;
  background: #020617;
  color: white;
  padding: 16px;
}
h1 { font-size: 22px; text-align:center; }

button {
  width: 22%;
  padding: 14px;
  font-size: 22px;
  margin: 1%;
  border-radius: 12px;
  border: none;
  background: #2563eb;
  color: white;
}
.full { width:100%; margin-top:10px; }
.reset { background:#dc2626; }

.card {
  background: #0f172a;
  padding: 14px;
  border-radius: 14px;
  margin-top: 14px;
}

.big-bet {
  background: linear-gradient(135deg,#1d4ed8,#2563eb);
  text-align: center;
}

.big-bet .amount {
  font-size: 48px;
  font-weight: bold;
  margin: 10px 0;
}

.big-bet .label {
  font-size: 14px;
  opacity: 0.9;
}

.big {
  font-size: 22px;
  font-weight: bold;
}

.ok { color:#22c55e; }
.bad { color:#ef4444; }

input {
  width: 100%;
  font-size: 16px;
  margin: 4px 0;
}

canvas {
  background:#020617;
  border-radius:12px;
}
.small { font-size:13px; opacity:0.85; }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<h1>ğŸ“Š Markovi Ennustaja</h1>

<div>
  <button onclick="inputNum(0)">0</button>
  <button onclick="inputNum(1)">1</button>
  <button onclick="inputNum(2)">2</button>
  <button onclick="inputNum(3)">3</button>
</div>

<button class="full reset" onclick="resetAll()">ğŸ”„ Reset</button>

<!-- TULEMUS -->
<div class="card" id="result">Ootan sisenditâ€¦</div>

<!-- SUUR PANUS -->
<div class="card big-bet" id="betCard">
  <div class="label">ğŸ¯ JÃ„RGMINE PANUSTAMINE</div>
  <div class="amount">â€”</div>
  <div class="label">aste: â€”</div>
</div>

<!-- GRAAFIK -->
<div class="card">
  <b>ğŸ“ˆ TÃ¤psuse ajalugu</b>
  <canvas id="chart" height="160"></canvas>
  <div class="small" id="stats"></div>
</div>

<!-- PANUSED -->
<div class="card">
  <b>ğŸ’° Panuse astmed (20)</b>
  <div id="bets"></div>
</div>

<script>
// ===== STATE =====
let state = JSON.parse(localStorage.getItem("markovState")) || {
  history: [],
  transitions: {},
  miss: 0,
  bets: Array(20).fill(1),
  lastPrediction: null,
  lastResult: null,
  total: 0,
  correct: 0,
  timeline: []
};

// ===== MARKOV =====
function predict(){
  if(state.history.length<2) return 1;
  let k=state.history.slice(-2).join(",");
  let r=state.transitions[k];
  if(!r) return 1;
  return Object.keys(r).reduce((a,b)=>r[a]>r[b]?a:b);
}

// ===== INPUT =====
function inputNum(n){
  if(state.lastPrediction!==null){
    state.total++;
    if(state.lastPrediction==n){
      state.correct++;
      state.miss=0;
      state.lastResult="Ã•IGE";
      state.timeline.push(1);
    } else {
      state.miss++;
      state.lastResult="MÃ–Ã–DA";
      state.timeline.push(0);
    }
  }

  if(state.history.length>=2){
    let k=state.history.slice(-2).join(",");
    if(!state.transitions[k]) state.transitions[k]={};
    state.transitions[k][n]=(state.transitions[k][n]||0)+1;
  }

  let next=predict();
  state.lastPrediction=next;

  state.history.push(n);
  if(state.history.length>2) state.history.shift();

  save();
  updateUI(next);
  updateChart();
}

// ===== UI =====
function updateUI(next){
  let acc=state.total?((state.correct/state.total)*100).toFixed(1):"â€”";
  let missIdx=Math.min(state.miss,19);
  let bet=state.bets[missIdx];

  document.getElementById("result").innerHTML=`
  ğŸ“¥ Sisestatud: <b>${state.history.at(-1)}</b><br><br>

  ğŸ”® Eelmine ennustus: <b>${state.lastPrediction??"â€”"}</b><br>
  ğŸ“Š Tulemus:
  <b class="${state.lastResult==="Ã•IGE"?"ok":"bad"}">
    ${state.lastResult??"â€”"}
  </b><br><br>

  âŒ MÃ¶Ã¶da jÃ¤rjest: <b>${state.miss}</b><br>
  ğŸ‘‰ JÃ„RGMINE ENNUSTUS: <span class="big">${next}</span>
  `;

  document.querySelector(".big-bet .amount").innerText = bet;
  document.querySelector(".big-bet .label:last-child").innerText =
    `aste: ${missIdx+1}`;

  document.getElementById("stats").innerText=
    `Ã•ige: ${state.correct}/${state.total} (${acc}%)`;
}

// ===== RESET =====
function resetAll(){
  if(!confirm("Nullida kÃµik?"))return;
  let keep=state.bets;
  state={history:[],transitions:{},miss:0,bets:keep,
    lastPrediction:null,lastResult:null,total:0,correct:0,timeline:[]};
  save();
  chart.data.labels=[];chart.data.datasets[0].data=[];chart.update();
  document.getElementById("result").innerText="Reset tehtud.";
  document.querySelector(".big-bet .amount").innerText="â€”";
}

// ===== BETS =====
function drawBets(){
  let d=document.getElementById("bets");
  d.innerHTML="";
  state.bets.forEach((v,i)=>{
    d.innerHTML+=`
    <input type="number" value="${v}"
     onchange="state.bets[${i}]=Number(this.value);save()">
    <span class="small">aste ${i+1}</span><br>`;
  });
}

// ===== STORAGE =====
function save(){
  localStorage.setItem("markovState",JSON.stringify(state));
}

// ===== CHART =====
let ctx=document.getElementById("chart").getContext("2d");
let chart=new Chart(ctx,{
  type:"line",
  data:{labels:[],datasets:[{data:[],label:"Ã•ige(1)/MÃ¶Ã¶da(0)",borderWidth:2,tension:0.3}]},
  options:{scales:{y:{min:0,max:1,ticks:{stepSize:1}}}}
});
function updateChart(){
  chart.data.labels=state.timeline.map((_,i)=>i+1);
  chart.data.datasets[0].data=state.timeline;
  chart.update();
}

// INIT
drawBets();
updateChart();
</script>

</body>
</html>