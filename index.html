<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Markovi Ennustaja</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont;
  background: #0f172a;
  color: white;
  padding: 16px;
}
h1 { font-size: 22px; }
button {
  width: 22%;
  padding: 14px;
  font-size: 22px;
  margin: 1%;
  border-radius: 10px;
  border: none;
  background: #2563eb;
  color: white;
}
.full {
  width:100%;
  margin-top:10px;
}
.reset {
  background:#dc2626;
}
.card {
  background: #1e293b;
  padding: 12px;
  border-radius: 12px;
  margin-top: 12px;
}
input {
  width: 100%;
  font-size: 16px;
  margin: 3px 0;
}
.small { font-size: 14px; opacity: 0.85; }
.ok { color: #22c55e; }
.bad { color: #ef4444; }
canvas { background:#020617;border-radius:12px; }
</style>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<h1>ğŸ“Š Markovi Ennustaja</h1>

<div>
  <button onclick="inputNum(0)">0</button>
  <button onclick="inputNum(1)">1</button>
  <button onclick="inputNum(2)">2</button>
  <button onclick="inputNum(3)">3</button>
</div>

<button class="full reset" onclick="resetAll()">ğŸ”„ Reset</button>

<div class="card" id="result">
Ootan sisenditâ€¦
</div>

<div class="card">
<b>ğŸ“ˆ TÃ¤psuse graafik</b><br>
<canvas id="chart" height="180"></canvas>
<div class="small" id="stats"></div>
</div>

<div class="card">
<b>ğŸ’° Panused (20 astet)</b><br>
<div id="bets"></div>
</div>

<script>
// =======================
// STATE
// =======================
let state = JSON.parse(localStorage.getItem("markovState")) || {
  history: [],
  transitions: {},
  miss: 0,
  bets: Array(20).fill(1),
  lastPrediction: null,
  lastResult: null,
  total: 0,
  correct: 0,
  timeline: [] // 1 = Ãµige, 0 = mÃ¶Ã¶da
};

// =======================
// MARKOV PREDICT
// =======================
function predict() {
  if (state.history.length < 2) return 1;
  let key = state.history.slice(-2).join(",");
  let row = state.transitions[key];
  if (!row) return 1;
  return Object.keys(row).reduce((a,b)=>row[a]>row[b]?a:b);
}

// =======================
// INPUT
// =======================
function inputNum(n) {

  // Kontrollime EELMIST ennustust
  if (state.lastPrediction !== null) {
    state.total += 1;
    if (state.lastPrediction == n) {
      state.lastResult = "Ã•IGE";
      state.correct += 1;
      state.timeline.push(1);
      state.miss = 0;
    } else {
      state.lastResult = "MÃ–Ã–DA";
      state.timeline.push(0);
      state.miss += 1;
    }
  }

  // Ã•ppimine
  if (state.history.length >= 2) {
    let key = state.history.slice(-2).join(",");
    if (!state.transitions[key]) state.transitions[key] = {};
    state.transitions[key][n] = (state.transitions[key][n] || 0) + 1;
  }

  // Uus ennustus
  let nextPrediction = predict();
  state.lastPrediction = nextPrediction;

  // Ajalugu
  state.history.push(n);
  if (state.history.length > 2) state.history.shift();

  save();
  updateUI(nextPrediction);
  updateChart();
}

// =======================
// UI
// =======================
function updateUI(nextPrediction){
  let acc = state.total
    ? ((state.correct/state.total)*100).toFixed(1)
    : "â€”";

  document.getElementById("result").innerHTML = `
    ğŸ“¥ Sisestatud: <b>${state.history[state.history.length-1]}</b><br><br>

    ğŸ”® Eelmine ennustus: <b>${state.lastPrediction ?? "â€”"}</b><br>
    ğŸ“Š Tulemus:
    <b class="${state.lastResult==="Ã•IGE"?"ok":"bad"}">
      ${state.lastResult ?? "â€”"}
    </b><br><br>

    âŒ MÃ¶Ã¶da jÃ¤rjest: <b>${state.miss}</b><br>
    ğŸ’° Soovituslik panus:
    <b>${state.bets[Math.min(state.miss,19)]}</b><br><br>

    ğŸ‘‰ JÃ„RGMINE ennustus: <b>${nextPrediction}</b>
  `;

  document.getElementById("stats").innerHTML =
    `Ã•ige: ${state.correct} / ${state.total} (${acc}%)`;
}

// =======================
// RESET
// =======================
function resetAll(){
  if (!confirm("Kas soovid kogu mudeli ja statistika nullida?")) return;

  let keepBets = state.bets;

  state = {
    history: [],
    transitions: {},
    miss: 0,
    bets: keepBets,
    lastPrediction: null,
    lastResult: null,
    total: 0,
    correct: 0,
    timeline: []
  };

  save();
  chart.data.labels = [];
  chart.data.datasets[0].data = [];
  chart.update();

  document.getElementById("result").innerHTML =
    "ğŸ”„ Reset tehtud. Ootan uut sisenditâ€¦";
}

// =======================
// BETS
// =======================
function drawBets(){
  let d = document.getElementById("bets");
  d.innerHTML="";
  state.bets.forEach((v,i)=>{
    d.innerHTML+=`
      <input type="number" value="${v}"
       onchange="state.bets[${i}]=Number(this.value);save()">
      <span class="small">aste ${i+1}</span><br>`;
  });
}

// =======================
// STORAGE
// =======================
function save(){
  localStorage.setItem("markovState",JSON.stringify(state));
}

// =======================
// CHART
// =======================
let ctx = document.getElementById("chart").getContext("2d");
let chart = new Chart(ctx,{
  type:"line",
  data:{
    labels:[],
    datasets:[{
      label:"TÃ¤psus (1=Ãµige, 0=mÃ¶Ã¶da)",
      data:[],
      tension:0.3,
      borderWidth:2
    }]
  },
  options:{
    scales:{
      y:{min:0,max:1,ticks:{stepSize:1}}
    }
  }
});

function updateChart(){
  chart.data.labels = state.timeline.map((_,i)=>i+1);
  chart.data.datasets[0].data = state.timeline;
  chart.update();
}

// INIT
drawBets();
updateChart();
</script>

</body>
</html>