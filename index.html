<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Markovi Ennustaja</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont;
  background:#020617;color:white;padding:16px
}
h1{text-align:center}

button{
  width:22%;padding:14px;font-size:22px;
  margin:1%;border-radius:12px;
  border:none;background:#2563eb;color:white
}
.full{width:100%}
.reset{background:#dc2626}

.card{
  background:#0f172a;
  padding:14px;border-radius:14px;
  margin-top:14px
}

.big{
  text-align:center;
  background:linear-gradient(135deg,#1d4ed8,#2563eb)
}
.amount{font-size:52px;font-weight:bold}
.label{opacity:.85}
.green{color:#22c55e}
.yellow{color:#eab308}
.red{color:#ef4444}

input{width:100%;font-size:16px;margin:4px 0}

canvas{background:#020617;border-radius:12px}
.small{font-size:13px;opacity:.8}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<h1>ğŸ“Š Markovi Ennustaja</h1>

<div>
  <button onclick="inputNum(0)">0</button>
  <button onclick="inputNum(1)">1</button>
  <button onclick="inputNum(2)">2</button>
  <button onclick="inputNum(3)">3</button>
</div>

<button class="full reset" onclick="resetAll()">ğŸ”„ Reset</button>

<div class="card" id="result">Ootan sisenditâ€¦</div>

<!-- CONFIDENCE -->
<div class="card big">
  <div class="label">ğŸ§  CONFIDENCE</div>
  <div class="amount" id="confidence">â€”</div>
</div>

<!-- NEXT BET -->
<div class="card big">
  <div class="label">ğŸ’° JÃ„RGMINE PANUS</div>
  <div class="amount" id="nextBet">â€”</div>
  <div class="small" id="betReason"></div>
</div>

<!-- CONF LIMIT -->
<div class="card">
  <b>âš™ï¸ Minimaalne confidence (%)</b>
  <input type="number" id="confLimit" value="45"
         onchange="save()">
</div>

<div class="card">
  <b>ğŸ“ˆ TÃ¤psuse ajalugu</b>
  <canvas id="chart" height="150"></canvas>
</div>

<div class="card">
  <b>ğŸ’° Panuse astmed</b>
  <div id="bets"></div>
</div>

<script>
// ===== STATE =====
let state=JSON.parse(localStorage.getItem("markovState"))||{
  history:[],transitions:{},miss:0,
  bets:Array(20).fill(1),
  lastPrediction:null,
  total:0,correct:0,timeline:[]
};

// ===== CONFIDENCE =====
function confidence(){
  if(state.history.length<2) return null;
  let k=state.history.slice(-2).join(",");
  let r=state.transitions[k];
  if(!r) return null;
  let sum=Object.values(r).reduce((a,b)=>a+b,0);
  let max=Math.max(...Object.values(r));
  return Math.round(max/sum*100);
}

// ===== PREDICT =====
function predict(){
  if(state.history.length<2) return 1;
  let k=state.history.slice(-2).join(",");
  let r=state.transitions[k];
  if(!r) return 1;
  return Object.keys(r).reduce((a,b)=>r[a]>r[b]?a:b);
}

// ===== INPUT =====
function inputNum(n){
  let conf=confidence();
  let limit=Number(document.getElementById("confLimit").value);

  // kontrollime ainult kui panustasime
  if(state.lastPrediction!==null && conf!==null && conf>=limit){
    state.total++;
    if(state.lastPrediction==n){
      state.correct++; state.miss=0; state.timeline.push(1);
    }else{
      state.miss++; state.timeline.push(0);
    }
  }

  if(state.history.length>=2){
    let k=state.history.slice(-2).join(",");
    if(!state.transitions[k]) state.transitions[k]={};
    state.transitions[k][n]=(state.transitions[k][n]||0)+1;
  }

  state.history.push(n);
  if(state.history.length>2) state.history.shift();
  state.lastPrediction=predict();

  save();
  updateUI();
  updateChart();
}

// ===== UI =====
function updateUI(){
  let conf=confidence();
  let limit=Number(document.getElementById("confLimit").value);
  let missIdx=Math.min(state.miss,19);
  let baseBet=state.bets[missIdx];

  let bet=0,reason="";
  if(conf===null){
    reason="Pole piisavalt andmeid";
  }else if(conf<limit){
    reason=`Confidence ${conf}% < ${limit}% â†’ EI PANUSTA`;
  }else{
    bet=baseBet;
    reason="Panus lubatud";
  }

  let confEl=document.getElementById("confidence");
  confEl.innerText=conf===null?"â€”":conf+"%";
  confEl.className="amount "+(conf>=60?"green":conf>=40?"yellow":"red");

  document.getElementById("nextBet").innerText=bet;
  document.getElementById("betReason").innerText=reason;

  document.getElementById("result").innerHTML=`
    ğŸ”® JÃ¤rgmine ennustus: <b>${state.lastPrediction}</b><br>
    âŒ MÃ¶Ã¶da jÃ¤rjest: <b>${state.miss}</b><br>
    ğŸ“Š TÃ¤psus: ${state.correct}/${state.total}
  `;
}

// ===== RESET =====
function resetAll(){
  if(!confirm("Reset?"))return;
  let b=state.bets;
  state={history:[],transitions:{},miss:0,bets:b,
    lastPrediction:null,total:0,correct:0,timeline:[]};
  save();updateUI();updateChart();
}

// ===== BETS =====
function drawBets(){
  let d=document.getElementById("bets"); d.innerHTML="";
  state.bets.forEach((v,i)=>{
    d.innerHTML+=`
      <input type="number" value="${v}"
      onchange="state.bets[${i}]=Number(this.value);save()">
      <span class="small">aste ${i+1}</span><br>`;
  });
}

// ===== STORAGE =====
function save(){
  localStorage.setItem("markovState",JSON.stringify(state));
}

// ===== CHART =====
let ctx=document.getElementById("chart").getContext("2d");
let chart=new Chart(ctx,{
  type:"line",
  data:{labels:[],datasets:[{data:[],label:"Ã•ige(1)/MÃ¶Ã¶da(0)",tension:.3}]},
  options:{scales:{y:{min:0,max:1,ticks:{stepSize:1}}}}
});
function updateChart(){
  chart.data.labels=state.timeline.map((_,i)=>i+1);
  chart.data.datasets[0].data=state.timeline;
  chart.update();
}

// INIT
drawBets();
updateUI();
updateChart();
</script>

</body>
</html>