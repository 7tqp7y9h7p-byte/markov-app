<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Markov Predictor</title>

<style>
body { font-family: -apple-system, Arial; background:#111; color:#eee; margin:0; padding:10px; }
h2 { margin-top:10px; }
button { padding:12px; font-size:16px; border-radius:8px; border:none; color:#fff; }
button:disabled { opacity:0.4; }

.btn-row { display:flex; gap:6px; margin-bottom:10px; }
.btn-row button { flex:1; }

.b0 { background:#555; }
.b1 { background:#2ecc71; }
.b2 { background:#f1c40f; }
.b3 { background:#e74c3c; }

input { width:60px; padding:6px; margin:3px; }

.box { background:#1c1c1c; padding:10px; border-radius:10px; margin-bottom:10px; }
.big { font-size:28px; font-weight:bold; }
.small { font-size:14px; opacity:0.8; }

table { width:100%; font-size:13px; }
td { padding:3px; border-bottom:1px solid #333; }
</style>
</head>

<body>

<h2>Markov Ennustaja</h2>

<div class="btn-row">
  <button class="b0" onclick="inputNum(0)">0</button>
  <button class="b1" onclick="inputNum(1)">1</button>
  <button class="b2" onclick="inputNum(2)">2</button>
  <button class="b3" onclick="inputNum(3)">3</button>
</div>

<div class="box">
  <div class="big">Ennustus: <span id="pred">–</span></div>
  <div class="small">Confidence: <span id="conf">–</span>%</div>
</div>

<div class="box">
  <b>Min confidence panuseks (%)</b><br>
  <input type="number" id="minConf" value="60">
</div>

<div class="box">
  <b>Manuaalsed panused (20)</b><br>
  <div id="bets"></div>
</div>

<div class="box">
  <b>Bankroll:</b> <span id="bankroll">1000</span><br>
  <b>Aktiivne aste:</b> <span id="betStep">1</span><br>
  <button onclick="placeBet()" id="betBtn">PANUSTA</button>
  <button onclick="resetAll()">RESET</button>
</div>

<div class="box">
  <b>Ajalugu</b>
  <table id="history"></table>
</div>

<script>
var state = JSON.parse(localStorage.getItem("mk_state")) || {
  history: [],
  transitions: {},
  lastPrediction: null,
  bankroll: 1000,
  step: 0,
  manualBets: Array(20).fill(1),
  betHistory: []
};

function save(){ localStorage.setItem("mk_state", JSON.stringify(state)); }

function markovKey(){
  if(state.history.length < 2) return null;
  return state.history.slice(-2).join("");
}

function predict(){
  var key = markovKey();
  if(!key) return null;
  var r = state.transitions[key];
  if(!r) return null;

  var keys = Object.keys(r);
  if(keys.length === 0) return null;

  return +keys.reduce(function(a,b){ return r[a]>r[b]?a:b; });
}

function confidence(){
  var key = markovKey();
  var r = state.transitions[key];
  if(!r) return null;

  var sum=0,max=0;
  for(var n in r){ sum+=r[n]; if(r[n]>max) max=r[n]; }
  return sum ? Math.round(max/sum*100) : null;
}

function canBet(){
  var conf = confidence();
  var min = parseInt(document.getElementById("minConf").value,10);
  if(conf===null) return false;
  return conf >= min;
}

function inputNum(n){
  var key = markovKey();
  if(key){
    state.transitions[key] = state.transitions[key] || {};
    state.transitions[key][n] = (state.transitions[key][n]||0)+1;
  }

  state.history.push(n);
  if(state.history.length>500) state.history.shift();

  var pred = predict();
  state.lastPrediction = pred;

  save();
  updateUI();
}

function placeBet(){
  if(!canBet()){
    alert("Confidence liiga madal");
    return;
  }

  var bet = state.manualBets[state.step] || 1;
  var pred = state.lastPrediction;
  var last = state.history[state.history.length-1];

  var win = pred===last;
  state.bankroll += win ? bet*2 : -bet;
  state.betHistory.unshift({b:bet,p:pred,r:last,w:win});
  if(state.betHistory.length>100) state.betHistory.pop();

  state.step = win ? 0 : Math.min(state.step+1,19);

  save();
  updateUI();
}

function resetAll(){
  var bets = state.manualBets.slice();
  state = {
    history: [],
    transitions: {},
    lastPrediction: null,
    bankroll: 1000,
    step: 0,
    manualBets: bets,
    betHistory: []
  };
  save();
  updateUI();
}

function updateUI(){
  document.getElementById("pred").innerText = state.lastPrediction ?? "–";
  document.getElementById("conf").innerText = confidence() ?? "–";
  document.getElementById("bankroll").innerText = state.bankroll;
  document.getElementById("betStep").innerText = state.step+1;

  document.getElementById("betBtn").disabled = !canBet();

  var h = document.getElementById("history");
  h.innerHTML = state.betHistory.map(function(x){
    return "<tr><td>"+x.b+"</td><td>"+x.p+"</td><td>"+x.r+"</td><td>"+(x.w?"✔":"✖")+"</td></tr>";
  }).join("");

  var b = document.getElementById("bets");
  b.innerHTML="";
  for(var i=0;i<20;i++){
    (function(i){
      var inp=document.createElement("input");
      inp.type="number";
      inp.value=state.manualBets[i];
      inp.onchange=function(){
        state.manualBets[i]=+this.value||1;
        save();
      };
      b.appendChild(inp);
    })(i);
  }
}

updateUI();
</script>
</body>
</html>