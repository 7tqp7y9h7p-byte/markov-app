<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Markovi Ennustaja</title>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont;
  background:#020617;color:white;padding:16px
}
h1{text-align:center}

button{
  width:22%;padding:14px;font-size:22px;
  margin:1%;border-radius:12px;
  border:none;background:#2563eb;color:white
}
.full{width:100%}
.reset{background:#dc2626}

.card{
  background:#0f172a;
  padding:14px;border-radius:14px;
  margin-top:14px
}

.big{
  text-align:center;
  background:linear-gradient(135deg,#1d4ed8,#2563eb)
}
.amount{font-size:56px;font-weight:bold}
.label{opacity:.85}

.prediction{
  background:linear-gradient(135deg,#047857,#16a34a)
}
.prediction .amount{font-size:72px}

.confSmall{font-size:16px;opacity:.85}

.green{color:#22c55e}
.yellow{color:#eab308}
.red{color:#ef4444}

input{width:100%;font-size:16px;margin:4px 0}
canvas{background:#020617;border-radius:12px}
.small{font-size:13px;opacity:.8}
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

<h1>ğŸ“Š Markovi Ennustaja</h1>

<div>
  <button onclick="inputNum(0)">0</button>
  <button onclick="inputNum(1)">1</button>
  <button onclick="inputNum(2)">2</button>
  <button onclick="inputNum(3)">3</button>
</div>

<button class="full reset" onclick="resetAll()">ğŸ”„ Reset</button>

<!-- ENNUSTUS -->
<div class="card big prediction">
  <div class="label">ğŸ”® JÃ„RGMINE ENNUSTUS</div>
  <div class="amount" id="nextPrediction">â€”</div>
  <div class="confSmall" id="confidence">Confidence â€”</div>
</div>

<!-- PANUS -->
<div class="card big">
  <div class="label">ğŸ’° JÃ„RGMINE PANUS</div>
  <div class="amount" id="nextBet">â€”</div>
  <div class="small" id="betReason"></div>
</div>

<!-- BANKROLL -->
<div class="card big">
  <div class="label">ğŸ¦ BANKROLL</div>
  <div class="amount" id="bankroll">â€”</div>
  <div class="small" id="roi"></div>
</div>

<div class="card">
  <b>âš™ï¸ Min confidence (%)</b>
  <input type="number" id="confLimit" value="45" onchange="save()">

  <b>ğŸ’¼ Algne bankroll</b>
  <input type="number" id="startBank" value="1000"
         onchange="resetAll(true)">
</div>

<div class="card">
  <b>ğŸ“ˆ TÃ¤psuse ajalugu</b>
  <canvas id="chart" height="150"></canvas>
</div>

<script>
// ===== STATE =====
let state=JSON.parse(localStorage.getItem("markovState"))||{
  history:[],transitions:{},miss:0,
  bets:Array(20).fill(1),
  lastPrediction:null,
  total:0,correct:0,timeline:[],
  bankroll:1000, invested:0
};

// ===== CONFIDENCE =====
function confidence(){
  if(state.history.length<2) return null;
  let k=state.history.slice(-2).join(",");
  let r=state.transitions[k];
  if(!r) return null;
  let sum=Object.values(r).reduce((a,b)=>a+b,0);
  let max=Math.max(...Object.values(r));
  return Math.round(max/sum*100);
}

// ===== PREDICT =====
function predict(){
  if(state.history.length<2) return 1;
  let k=state.history.slice(-2).join(",");
  let r=state.transitions[k];
  if(!r) return 1;
  return Object.keys(r).reduce((a,b)=>r[a]>r[b]?a:b);
}

// ===== INPUT =====
function inputNum(n){
  let conf=confidence();
  let limit=Number(confLimit.value);
  let missIdx=Math.min(state.miss,19);
  let bet=state.bets[missIdx];
  let panusta=conf!==null && conf>=limit;

  if(state.lastPrediction!==null && panusta){
    state.invested+=bet;
    if(state.lastPrediction==n){
      state.correct++;
      state.miss=0;
      state.timeline.push(1);
      state.bankroll+=bet;
    }else{
      state.miss++;
      state.timeline.push(0);
      state.bankroll-=bet;
    }
    state.total++;
  }

  if(state.history.length>=2){
    let k=state.history.slice(-2).join(",");
    state.transitions[k]??={};
    state.transitions[k][n]=(state.transitions[k][n]||0)+1;
  }

  state.history.push(n);
  if(state.history.length>2) state.history.shift();
  state.lastPrediction=predict();

  save();updateUI();updateChart();
}

// ===== UI =====
function updateUI(){
  let conf=confidence();
  let limit=Number(confLimit.value);
  let missIdx=Math.min(state.miss,19);
  let bet=state.bets[missIdx];

  let can=conf!==null && conf>=limit;

  nextPrediction.innerText=state.lastPrediction??"â€”";
  confidence.innerText=conf?`Confidence ${conf}%`:"Confidence â€”";
  confidence.className="confSmall "+
    (conf>=60?"green":conf>=40?"yellow":"red");

  nextBet.innerText=can?bet:0;
  betReason.innerText=can?"Panus lubatud":"EI PANUSTA";

  bankroll.innerText=state.bankroll.toFixed(2);
  roi.innerText=state.invested
    ? `ROI ${( (state.bankroll-Number(startBank.value))/state.invested*100).toFixed(1)}%`
    : "ROI â€”";
}

// ===== RESET =====
function resetAll(full=false){
  let b=state.bets;
  let start=Number(startBank.value);
  state={
    history:[],transitions:{},miss:0,bets:b,
    lastPrediction:null,total:0,correct:0,timeline:[],
    bankroll:start,invested:0
  };
  save();updateUI();updateChart();
}

// ===== STORAGE =====
function save(){
  localStorage.setItem("markovState",JSON.stringify(state));
}

// ===== CHART =====
let ctx=chart.getContext("2d");
let chartObj=new Chart(ctx,{
  type:"line",
  data:{labels:[],datasets:[{data:[],label:"Ã•ige(1)/MÃ¶Ã¶da(0)"}]},
  options:{scales:{y:{min:0,max:1}}}
});
function updateChart(){
  chartObj.data.labels=state.timeline.map((_,i)=>i+1);
  chartObj.data.datasets[0].data=state.timeline;
  chartObj.update();
}

updateUI();updateChart();
</script>

</body>
</html>