<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Markov Ennustaja</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont;
  background: #020617;
  color: white;
  padding: 14px;
}

/* NUMBRINUPUD */
.btn-row {
  display: flex;
  gap: 8px;
}
.btn-row button {
  flex: 1;
  padding: 18px;
  font-size: 26px;
  border-radius: 14px;
  border: none;
  color: white;
}

/* v√§rvid */
.btn-0 { background:#16a34a; }   /* roheline */
.btn-1 { background:#2563eb; }   /* sinine */
.btn-2 { background:#f59e0b; }   /* oran≈æ */
.btn-3 { background:#dc2626; }   /* punane */


.card {
  background: #0f172a;
  padding: 14px;
  border-radius: 14px;
  margin-top: 12px;
}
.big {
  font-size: 34px;
  font-weight: bold;
  text-align: center;
}
.small {
  font-size: 13px;
  opacity: 0.7;
  text-align: center;
}

.reset {
  background: #7c2d12;
  width: 100%;
  padding: 14px;
  font-size: 18px;
  border-radius: 12px;
  border: none;
  color: white;
  margin-top: 10px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 6px;
}
input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: none;
}
.active {
  outline: 2px solid #22c55e;
}

.green { color:#22c55e; }
.red { color:#ef4444; }

table { width:100%; font-size:12px; }
td,th { padding:4px; text-align:center; }
</style>
</head>

<body>

<h2>üìä Markov Ennustaja</h2>

<div class="btn-row">
  <button class="btn-0" onclick="inputNum(0)">0</button>
  <button class="btn-1" onclick="inputNum(1)">1</button>
  <button class="btn-2" onclick="inputNum(2)">2</button>
  <button class="btn-3" onclick="inputNum(3)">3</button>
</div>

<div class="card">
  <div class="small">üîÆ J√ÑRGMINE ENNUSTUS</div>
  <div class="big" id="pred">‚Äî</div>
  <div class="small" id="conf">Confidence ‚Äî</div>
</div>

<div class="card">
  <div class="small">üí∞ J√ÑRGMINE PANUS</div>
  <div class="big" id="nextBet">‚Äî</div>
</div>

<button class="reset" onclick="resetAll()">üîÑ RESET</button>

<div class="card">
  <div class="small">‚úçÔ∏è MANUAALSED PANUSED (20)</div>
  <div class="grid" id="betGrid">
    <input type="number"><input type="number"><input type="number"><input type="number"><input type="number">
    <input type="number"><input type="number"><input type="number"><input type="number"><input type="number">
    <input type="number"><input type="number"><input type="number"><input type="number"><input type="number">
    <input type="number"><input type="number"><input type="number"><input type="number"><input type="number">
  </div>
</div>

<div class="card">
  Bankroll: <b id="bankroll">0</b><br>
  Vajutusi: <b id="clicks">0</b><br>
  Panuseid: <b id="bets">0</b><br>
  Aktiivne aste: <b id="step">1</b>
</div>

<div class="card">
  <b>üìú Panuste ajalugu</b>
  <table id="history"></table>
</div>

<script>
function $(id){ return document.getElementById(id); }

var state = JSON.parse(localStorage.getItem("mk_state")) || {
  history: [],
  transitions: {},
  lastPrediction: null,
  bankroll: 1000,
  clicks: 0,
  bets: 0,
  manualBets: Array(20).fill(1),
  index: 0,
  betHistory: []
};

var MIN_CONFIDENCE = 60; // 
var inputs = $("betGrid").getElementsByTagName("input");
for(var i=0;i<inputs.length;i++){
  inputs[i].value = state.manualBets[i];
  (function(i){
    inputs[i].oninput = function(){
      state.manualBets[i] = Number(inputs[i].value) || 0;
      save();
      updateUI();
    };
  })(i);
}

function markovKey(){
  if(state.history.length < 2) return null;
  return state.history[state.history.length-2] + "," +
         state.history[state.history.length-1];
}

function predict(){
  var key = markovKey();
  var r = state.transitions[key];
  if(!r) return null;
  var best = null, max = -1;
  for(var n in r){
    if(r[n] > max){ max = r[n]; best = n; }
  }
  return best !== null ? Number(best) : null;
}

function confidence(){
  var key = markovKey();
  var r = state.transitions[key];
  if(!r) return null;
  var sum = 0, max = 0;
  for(var n in r){ sum += r[n]; if(r[n] > max) max = r[n]; }
  return sum ? Math.round(max / sum * 100) : null;
}
function canBet(){
  var conf = confidence();
  if(conf === null) return false;
  return conf >= MIN_CONFIDENCE;
}

function inputNum(n){
  state.clicks++;

  var bet = state.manualBets[state.index] || 0;

  if(state.lastPrediction !== null){
    state.bets++;
    var win = (n === state.lastPrediction);
    if(win){
      state.bankroll += bet * 2;
      state.index = 0;
    } else {
      state.bankroll -= bet;
      if(state.index < 19) state.index++;
    }
    state.betHistory.unshift({
      p: state.lastPrediction,
      r: n,
      b: bet,
      w: win,
      br: state.bankroll
    });
    if(state.betHistory.length > 500)
      state.betHistory.pop();
  }
  function placeBet(){
  if(!canBet()){
    alert("Confidence liiga madal");
    return;
  }

  var bet = state.manualBets[state.step] || 1;
  var pred = state.lastPrediction;
  var last = state.history[state.history.length-1];

  var win = pred===last;
  state.bankroll += win ? bet*2 : -bet;
  state.betHistory.unshift({b:bet,p:pred,r:last,w:win});
  if(state.betHistory.length>100) state.betHistory.pop();

  state.step = win ? 0 : Math.min(state.step+1,19);

  save();
  updateUI();
}

  var key = markovKey();
  if(key){
    if(!state.transitions[key])
      state.transitions[key] = {};
    state.transitions[key][n] =
      (state.transitions[key][n] || 0) + 1;
  }

  state.history.push(n);
  if(state.history.length > 3)
    state.history.shift();

  state.lastPrediction = predict();
  save();
  updateUI();
}

function updateUI(){
  $("pred").innerHTML =
    state.lastPrediction !== null ? state.lastPrediction : "‚Äî";

  var c = confidence();
  $("conf").innerHTML =
    c ? ("Confidence " + c + "%") : "Confidence ‚Äî";

  $("nextBet").innerHTML =
    state.manualBets[state.index] || "‚Äî";

  $("bankroll").innerHTML = state.bankroll.toFixed(2);
  $("clicks").innerHTML = state.clicks;
  $("bets").innerHTML = state.bets;
  $("step").innerHTML = state.index + 1;

  for(var i=0;i<inputs.length;i++){
    inputs[i].className =
      (i === state.index) ? "active" : "";
  }

  var h =
    "<tr><th>#</th><th>Enn</th><th>Tulemus</th><th>Panus</th><th>BR</th></tr>";

  for(var i=0;i<state.betHistory.length;i++){
    var x = state.betHistory[i];
    h += "<tr class='" + (x.w?"green":"red") + "'>" +
      "<td>"+(state.betHistory.length-i)+"</td>" +
      "<td>"+x.p+" ‚Üí "+x.r+"</td>" +
      "<td>"+(x.w?"WIN":"LOSS")+"</td>" +
      "<td>"+x.b+"</td>" +
      "<td>"+x.br.toFixed(2)+"</td></tr>";
  }
  $("history").innerHTML = h;
}

function resetAll(){
  var keepBets = state.manualBets.slice();

  state = {
    history: [],
    transitions: {},
    lastPrediction: null,
    bankroll: 1000,
    clicks: 0,
    bets: 0,
    manualBets: keepBets,
    index: 0,
    betHistory: []
  };

  save();
  updateUI();
}

function save(){
  localStorage.setItem("mk_state", JSON.stringify(state));
}

updateUI();
</script>

</body>
</html>