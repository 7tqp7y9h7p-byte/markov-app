<!DOCTYPE html>
<html lang="et">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Markov Ennustaja</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont;
  background: #020617;
  color: white;
  padding: 14px;
}

.btn-row { display:flex; gap:8px; }
.btn-row button {
  flex:1; padding:18px; font-size:26px;
  border-radius:14px; border:none; color:white;
}

.btn-0{background:#16a34a;}
.btn-1{background:#2563eb;}
.btn-2{background:#f59e0b;}
.btn-3{background:#dc2626;}

.card {
  background:#0f172a;
  padding:14px;
  border-radius:14px;
  margin-top:12px;
}

.big { font-size:34px; font-weight:bold; text-align:center; }
.small { font-size:13px; opacity:.7; text-align:center; }

.reset {
  width:100%; padding:14px; font-size:18px;
  border-radius:12px; border:none; color:white;
  margin-top:8px;
}
.reset.red{background:#7c2d12;}
.reset.gray{background:#334155;}

.grid {
  display:grid;
  grid-template-columns:repeat(5,1fr);
  gap:6px;
}

input[type=number]{
  width:100%; padding:8px;
  border-radius:8px; border:none;
}

input[type=range]{width:100%;}

.active{outline:2px solid #22c55e;}
.green{color:#22c55e;}
.redtxt{color:#ef4444;}

table{width:100%; font-size:12px;}
td,th{padding:4px; text-align:center;}
</style>
</head>

<body>

<h2>üìä Markov Ennustaja</h2>

<div class="btn-row">
  <button class="btn-0" onclick="inputNum(0)">0</button>
  <button class="btn-1" onclick="inputNum(1)">1</button>
  <button class="btn-2" onclick="inputNum(2)">2</button>
  <button class="btn-3" onclick="inputNum(3)">3</button>
</div>

<div class="card">
  <div class="small">üîÆ J√ÑRGMINE ENNUSTUS</div>
  <div class="big" id="pred">‚Äî</div>
  <div class="small" id="conf">Confidence ‚Äî</div>
</div>

<div class="card">
  <div class="small">üí∞ J√ÑRGMINE PANUS</div>
  <div class="big" id="nextBet">‚Äî</div>
</div>

<div class="card">
  <div class="small">‚öñÔ∏è MUDELITE KAALUD</div>

  <div class="small">Markov</div>
  <input type="range" min="0" max="200" value="100" id="wMarkov">
  <div class="small"><b id="wMarkovVal">1.00</b></div>

  <div class="small">Sagedus</div>
  <input type="range" min="0" max="200" value="50" id="wFreq">
  <div class="small"><b id="wFreqVal">0.50</b></div>
</div>

<div class="card">
  <div class="small">üéö Min confidence panustamiseks</div>
  <input type="range" min="0" max="100" value="0" id="confLimit">
  <div class="small">Valitud: <b id="confLimitVal">0%</b></div>
</div>

<button class="reset red" onclick="resetAll()">üîÑ RESET</button>
<button class="reset gray" onclick="undo()">‚Ü©Ô∏è UNDO</button>

<div class="card">
  <div class="small">‚úçÔ∏è MANUAALSED PANUSED (20)</div>
  <div class="grid" id="betGrid"></div>
</div>

<div class="card">
  Bankroll: <b id="bankroll">0</b><br>
  Vajutusi: <b id="clicks">0</b><br>
  Panuseid: <b id="bets">0</b><br>
  Aktiivne aste: <b id="step">1</b>
</div>

<div class="card">
  <b>üìú Panuste ajalugu</b>
  <table id="history"></table>
</div>

<script>
function $(id){ return document.getElementById(id); }

var state = JSON.parse(localStorage.getItem("mk_state")) || {
  history: [],
  transitions: {},
  lastPrediction: null,
  bankroll: 1000,
  clicks: 0,
  bets: 0,
  manualBets: Array(20).fill(1),
  index: 0,
  betHistory: []
};

function save(){ localStorage.setItem("mk_state", JSON.stringify(state)); }

/* ================= MARKOV ================= */
function markovKey(){
  if(state.history.length < 2) return null;
  return state.history[state.history.length-2] + "," +
         state.history[state.history.length-1];
}

function predict(){
  var key = markovKey();
  var r = state.transitions[key];
  if(!r) return null;
  var best=null,max=-1;
  for(var n in r){
    if(r[n]>max){ max=r[n]; best=n; }
  }
  return best!==null ? Number(best) : null;
}

function confidence(){
  var key = markovKey();
  var r = state.transitions[key];
  if(!r) return null;
  var sum=0,max=0;
  for(var n in r){ sum+=r[n]; if(r[n]>max) max=r[n]; }
  return sum ? Math.round(max/sum*100) : null;
}

/* ============== SAGEDUS ================= */
function freqPredict(){
  var c=[0,0,0,0];
  state.history.forEach(n=>c[n]++);
  var max=Math.max(...c);
  if(max===0) return null;
  return c.indexOf(max);
}

/* ============== TREND / ANTI-STREAK ================= */
function trendPredict(){
  if(state.history.length < 2) return null;

  var a = state.history[state.history.length - 1];
  var b = state.history[state.history.length - 2];

  // kui kordub ‚Üí murra
  if(a === b){
    return (a + 1) % 4;
  }

  // kui vaheldub ‚Üí j√§tka
  return a;
}

/* ========== KOMBINATSIOON =============== */
function combinedPredict(){
  var votes=[0,0,0,0];

  var wM = $("wMarkov").value / 100;
  var wF = $("wFreq").value / 100;

  // üëâ SIIN ON √ïIGE KOHT
  var c = confidence() || 0;
  var wT = c < 40 ? 0.5 : 0.2;

  var m = predict();
  if(m!==null) votes[m] += wM;

  var f = freqPredict();
  if(f!==null) votes[f] += wF;

  // üëâ TREND / ANTI-STREAK MUDEL
  if(state.history.length >= 2){
    let last = state.history[state.history.length-1];
    let anti = (last + 1) % 4;
    votes[anti] += wT;
  }

  var best = votes.indexOf(Math.max(...votes));
  return votes[best] > 0 ? best : null;
}

/* ============== BET CONTROL ============= */
function canBet(){
  var c=confidence();
  var limit=Number($("confLimit").value);
  if(c===null) return false;
  return c>=limit;
}

/* ============== INPUT =================== */
function inputNum(n){
  state.clicks++;

  var bet=state.manualBets[state.index]||0;

  if(state.lastPrediction!==null && canBet()){
    state.bets++;
    var win=(n===state.lastPrediction);
    if(win){
      state.bankroll+=bet*2;
      state.index=0;
    }else{
      state.bankroll-=bet;
      if(state.index<19) state.index++;
    }
    state.betHistory.unshift({p:state.lastPrediction,r:n,b:bet,w:win,br:state.bankroll});
    if(state.betHistory.length>500) state.betHistory.pop();
  }

  var key=markovKey();
  if(key){
    state.transitions[key]=state.transitions[key]||{};
    state.transitions[key][n]=(state.transitions[key][n]||0)+1;
  }

  state.history.push(n);
  if(state.history.length>2) state.history.shift();

  state.lastPrediction = combinedPredict();
  save(); updateUI();
}

/* ================= UNDO ================= */
function undo(){
  if(state.betHistory.length===0) return;
  var last=state.betHistory.shift();
  if(last.w) state.bankroll-=last.b*2;
  else state.bankroll+=last.b;
  state.index=last.w?0:Math.max(state.index-1,0);
  state.history.pop();
  state.clicks=Math.max(state.clicks-1,0);
  state.bets=Math.max(state.bets-1,0);
  state.lastPrediction=combinedPredict();
  save(); updateUI();
}

/* ================= RESET ================= */
function resetAll(){
  var keep=state.manualBets.slice();
  state={
    history:[], transitions:{}, lastPrediction:null,
    bankroll:1000, clicks:0, bets:0,
    manualBets:keep, index:0, betHistory:[]
  };
  save(); updateUI();
}

/* ================= UI =================== */
function updateUI(){
  $("pred").innerHTML = state.lastPrediction ?? "‚Äî";
  var c=confidence();
  $("conf").innerHTML = c ? "Confidence "+c+"%" : "Confidence ‚Äî";
  $("confLimitVal").innerHTML = $("confLimit").value+"%";
  $("wMarkovVal").innerHTML = ($("wMarkov").value/100).toFixed(2);
  $("wFreqVal").innerHTML = ($("wFreq").value/100).toFixed(2);

  $("nextBet").innerHTML = canBet()?state.manualBets[state.index]:"‚Äî";
  $("bankroll").innerHTML = state.bankroll.toFixed(2);
  $("clicks").innerHTML = state.clicks;
  $("bets").innerHTML = state.bets;
  $("step").innerHTML = state.index+1;

  var grid=$("betGrid");
  if(!grid.children.length){
    for(let i=0;i<20;i++){
      let inp=document.createElement("input");
      inp.type="number";
      inp.value=state.manualBets[i];
      inp.oninput=()=>{ state.manualBets[i]=Number(inp.value)||0; save(); updateUI(); };
      grid.appendChild(inp);
    }
  }
  for(let i=0;i<20;i++)
    grid.children[i].className=(i===state.index)?"active":"";

  var h="<tr><th>#</th><th>Enn</th><th>Tulemus</th><th>Panus</th><th>BR</th></tr>";
  state.betHistory.forEach((x,i)=>{
    h+="<tr class='"+(x.w?"green":"redtxt")+"'><td>"+(state.betHistory.length-i)+
       "</td><td>"+x.p+"‚Üí"+x.r+"</td><td>"+(x.w?"WIN":"LOSS")+
       "</td><td>"+x.b+"</td><td>"+x.br.toFixed(2)+"</td></tr>";
  });
  $("history").innerHTML=h;
}

updateUI();
</script>
</body>
</html>